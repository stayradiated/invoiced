// Generated by CoffeeScript 1.6.3
(function() {
  var compile, config, content, fs, loadFiles, loaded, templates, tmpl, zip;

  fs = require('fs');

  zip = require('./zip');

  tmpl = function(template, namespace) {
    var fn;
    fn = function(existing, fieldName) {
      var content, field, fields, i, last, next, value, _i, _len;
      fields = fieldName.split('.');
      next = namespace;
      last = fields.length - 1;
      for (i = _i = 0, _len = fields.length; _i < _len; i = ++_i) {
        field = fields[i];
        value = next[field];
        if (i === last) {
          content = value;
        } else {
          next = value;
        }
      }
      if (content == null) {
        content = existing;
      }
      return content;
    };
    return template.replace(/\{{2}([A-Za-z0-9_|.]*)\}{2}/g, fn);
  };

  templates = {
    document: __dirname + '/../../../docs/document.xml.tmpl',
    rowHeading: __dirname + '/../../../docs/row.heading.xml.tmpl',
    rowNumber: __dirname + '/../../../docs/row.number.xml.tmpl',
    rowBullet: __dirname + '/../../../docs/row.bullet.xml.tmpl'
  };

  config = {
    template: __dirname + '/../../../docs/template/word/document.xml',
    folder: __dirname + '/../../../docs/template',
    output: __dirname + '/../../../docs/file.docx'
  };

  content = {};

  loaded = false;

  loadFiles = function() {
    var file, path, _results;
    _results = [];
    for (file in templates) {
      path = templates[file];
      content[file] = fs.readFileSync(path).toString();
      _results.push(loaded = true);
    }
    return _results;
  };

  compile = function(details, table) {
    var jobDate, output, row, startDate, _i, _len;
    if (!loaded) {
      loadFiles();
    }
    details.rows = "";
    startDate = '';
    jobDate = '';
    for (_i = 0, _len = table.length; _i < _len; _i++) {
      row = table[_i];
      row.jobDate = jobDate;
      switch (row.type) {
        case 'heading':
          details.rows += tmpl(content.rowHeading, row);
          break;
        case 'number':
          details.rows += tmpl(content.rowNumber, row);
          break;
        case 'bullet':
          details.rows += tmpl(content.rowBullet, row);
          break;
        case 'section':
          jobDate = row.name;
          if (startDate === '') {
            startDate = jobDate;
          }
      }
      if (row.type !== 'section') {
        jobDate = '';
      }
    }
    details.jobDate = startDate;
    output = tmpl(content.document, details);
    fs.writeFile(config.template, output);
    return zip(config.folder, config.output);
  };

  module.exports = compile;

}).call(this);
